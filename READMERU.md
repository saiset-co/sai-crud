# SAI CRUD Service

Микросервис для CRUD операций, созданный на Go с использованием SAI framework. Этот сервис предоставляет RESTful API для создания, чтения, обновления и удаления документов в коллекциях с настраиваемым хранилищем.

## Возможности

- **Полные CRUD операции**: Создание, чтение, обновление, удаление документов
- **Префиксы коллекций**: Поддержка префиксов коллекций для мультитенантности
- **Гибкое хранилище**: Интеграция с сервисом SAI Storage
- **Настраиваемость**: Конфигурация на основе переменных окружения с шаблонами
- **Готовность к Docker**: Контейнеризованное развертывание с Docker Compose
- **Проверки здоровья**: Встроенный мониторинг состояния
- **Документация API**: Автоматическая генерация OpenAPI документации
- **Поддержка middleware**: CORS, логирование, восстановление и аутентификация
- **Валидация**: Валидация запросов с comprehensive обработкой ошибок

## Быстрый старт

### Предварительные требования

- Go 1.21+ (для локальной разработки)
- Docker и Docker Compose (для контейнерного развертывания)
- Запущенный сервис SAI Storage

### Локальная разработка

1. **Клонировать репозиторий**
   ```bash
   git clone <repository-url>
   cd sai-crud
   ```

2. **Настроить окружение**
   ```bash
   cp .env.example .env
   # Отредактировать .env с вашей конфигурацией
   ```

3. **Установить зависимости**
   ```bash
   make deps
   ```

4. **Сгенерировать конфигурацию**
   ```bash
   make config
   ```

5. **Запустить сервис**
   ```bash
   make run
   ```

Сервис запустится на `http://localhost:8081` (настраивается через `SERVER_PORT`)

### Развертывание с Docker

1. **Запустить с Docker Compose**
   ```bash
   make up
   ```

2. **Просмотреть логи**
   ```bash
   make logs
   ```

3. **Остановить сервисы**
   ```bash
   make down
   ```

## Эндпоинты API

### Базовый URL
```
http://localhost:8081/api/v1
```

### Создание документов
```http
POST /api/v1/
Content-Type: application/json

{
  "prefix": "user",
  "data": [
    {"name": "John", "age": 30},
    {"name": "Jane", "age": 25}
  ]
}
```

### Чтение документов
```http
GET /api/v1/
Content-Type: application/json

{
  "prefix": "user",
  "filter": {"age": {"$gte": 25}},
  "sort": {"name": 1},
  "limit": 10,
  "skip": 0
}
```

### Обновление документов
```http
PUT /api/v1/
Content-Type: application/json

{
  "prefix": "user",
  "filter": {"name": "John"},
  "data": {"$set": {"age": 31, "status": "active"}}
}
```

**Операторы обновления:**
- `$set`: Установить значения полей
- `$unset`: Удалить поля
- `$inc`: Увеличить числовые значения
- `$push`: Добавить в массивы

**Примеры:**
```json
// Установить поля
{"data": {"$set": {"age": 31, "email": "john@example.com"}}}

// Удалить поля  
{"data": {"$unset": {"tempField": ""}}}

// Увеличить значение
{"data": {"$inc": {"views": 1}}}
```

### Удаление документов
```http
DELETE /api/v1/
Content-Type: application/json

{
  "prefix": "user",
  "filter": {"age": {"$lt": 18}}
}
```

## Конфигурация

Сервис использует переменные окружения для конфигурации. Основные настройки включают:

### Конфигурация сервиса
- `SERVICE_NAME`: Имя сервиса (по умолчанию: `sai-service`)
- `SERVICE_VERSION`: Версия сервиса (по умолчанию: `1.0.0`)
- `COLLECTION_NAME`: Имя коллекции по умолчанию (по умолчанию: `dictionary`)

### Конфигурация сервера
- `SERVER_HOST`: Хост сервера (по умолчанию: `127.0.0.1`)
- `SERVER_PORT`: Порт сервера (по умолчанию: `8081`)
- `SERVER_READ_TIMEOUT`: Таймаут чтения в секундах (по умолчанию: `30`)
- `SERVER_WRITE_TIMEOUT`: Таймаут записи в секундах (по умолчанию: `30`)
- `SERVER_IDLE_TIMEOUT`: Таймаут простоя в секундах (по умолчанию: `120`)

### Конфигурация хранилища
- `STORAGE_URL`: URL сервиса SAI Storage (по умолчанию: `http://localhost:8080`)
- `STORAGE_USERNAME`: Имя пользователя сервиса хранилища
- `STORAGE_PASSWORD`: Пароль сервиса хранилища

### Конфигурация логирования
- `LOG_LEVEL`: Уровень логирования (по умолчанию: `debug`)
- `LOG_OUTPUT`: Вывод логов (по умолчанию: `stdout`)
- `LOG_FORMAT`: Формат логов (по умолчанию: `console`)

## Разработка

### Доступные команды Make

```bash
# Разработка
make deps          # Скачать Go зависимости
make config        # Сгенерировать конфигурацию из шаблона
make run           # Запустить приложение локально
make build         # Собрать бинарный файл приложения

# Docker
make docker-build  # Собрать Docker образ
make docker-run    # Запустить Docker контейнер
make up            # Запустить все сервисы с docker-compose
make down          # Остановить все сервисы
make logs          # Показать логи всех сервисов
make restart       # Перезапустить все сервисы
make rebuild       # Пересобрать и перезапустить все сервисы

# Качество кода
make fmt           # Форматировать Go код
make vet           # Запустить go vet
make lint          # Запустить линтер (требует golangci-lint)

# Очистка
make clean         # Очистить артефакты сборки
make clean-docker  # Очистить Docker ресурсы
make clean-all     # Очистить все
```

### Структура проекта

```
.
├── cmd/                    # Точки входа приложения
│   └── main.go            # Главное приложение
├── internal/              # Внутренние пакеты
│   ├── handler.go         # HTTP обработчики
│   └── service.go         # Бизнес-логика
├── types/                 # Определения типов
│   ├── request.go         # Типы запросов
│   ├── response.go        # Типы ответов
│   └── types.go           # Типы сервиса
├── scripts/               # Скрипты развертывания
├── config.yaml.template   # Шаблон конфигурации
├── .env                   # Переменные окружения
├── Dockerfile             # Конфигурация Docker
├── docker-compose.yml     # Конфигурация Docker Compose
└── Makefile              # Автоматизация сборки
```

## Проверки здоровья

Сервис включает встроенные проверки здоровья:

```bash
curl http://localhost:8081/health
```

## Документация API

Когда `DOCS_ENABLED=true`, интерактивная документация API доступна по адресу:

```
http://localhost:8081/docs
```

## Аутентификация

Сервис поддерживает два типа аутентификации:

### Аутентификация входящих запросов
Настройка аутентификации для входящих API запросов:

```env
USERNAME=your-username
PASSWORD=your-password
```

### Аутентификация исходящих клиентов
Настройка аутентификации для исходящих запросов к другим сервисам (например, SAI Storage). Каждый клиент может иметь свой метод аутентификации и параметры, настроенные в `config.yaml`:

```yaml
clients:
  enabled: true
  services:
    storage:
      url: "http://localhost:8080"
      auth:
        provider: "basic"           # Метод аутентификации
        payload:
          username: "storage-user"
          password: "storage-pass"
```

**Поддерживаемые провайдеры аутентификации:**
- `basic`: HTTP Basic Authentication
- `bearer`: Bearer token authentication
- `api-key`: API key authentication
- Пользовательские провайдеры по конфигурации

**Переменные окружения для аутентификации клиентов:**
```env
STORAGE_URL=http://localhost:8080
STORAGE_AUTH_PROVIDER=basic
STORAGE_USERNAME=storage-user
STORAGE_PASSWORD=storage-pass
```

## Обработка ошибок

Все ответы API следуют единому формату:

**Успешный ответ:**
```json
{
  "data": [...],
  "created": 2
}
```

**Ответ с ошибкой:**
```json
{
  "error": "validation failed",
  "details": "specific error details"
}
```

## Мониторинг

Сервис включает:

- **Проверки здоровья**: эндпоинт `/health`
- **Метрики**: встроенный сбор метрик
- **Логирование**: структурированное логирование с настраиваемыми уровнями
- **Трассировка запросов**: middleware для логирования запросов/ответов

## Вклад в проект

1. Сделайте fork репозитория
2. Создайте ветку для новой функции
3. Внесите изменения
4. Запустите тесты и линтер
5. Отправьте pull request

## Лицензия

Этот проект лицензирован под лицензией MIT - подробности см. в файле LICENSE.

## Поддержка

По вопросам и проблемам создайте issue в репозитории или обратитесь к команде разработки.